#include <stdlib.h>
#include <float.h>
#include <limits.h>
#include <cml/errno.h>
#include <cml/math.h>
#include <cml/specfunc.h>


static long double const factorials[] = {
        1.000000000000000000000e+0L,         /*   0! */
        1.000000000000000000000e+0L,         /*   1! */
        2.000000000000000000000e+0L,         /*   2! */
        6.000000000000000000000e+0L,         /*   3! */
        2.400000000000000000000e+1L,         /*   4! */
        1.200000000000000000000e+2L,         /*   5! */
        7.200000000000000000000e+2L,         /*   6! */
        5.040000000000000000000e+3L,         /*   7! */
        4.032000000000000000000e+4L,         /*   8! */
        3.628800000000000000000e+5L,         /*   9! */
        3.628800000000000000000e+6L,         /*  10! */
        3.991680000000000000000e+7L,         /*  11! */
        4.790016000000000000000e+8L,         /*  12! */
        6.227020800000000000000e+9L,         /*  13! */
        8.717829120000000000000e+10L,        /*  14! */
        1.307674368000000000000e+12L,        /*  15! */
        2.092278988800000000000e+13L,        /*  16! */
        3.556874280960000000000e+14L,        /*  17! */
        6.402373705728000000000e+15L,        /*  18! */
        1.216451004088320000000e+17L,        /*  19! */
        2.432902008176640000000e+18L,        /*  20! */
        5.109094217170944000000e+19L,        /*  21! */
        1.124000727777607680000e+21L,        /*  22! */
        2.585201673888497664000e+22L,        /*  23! */
        6.204484017332394393600e+23L,        /*  24! */
        1.551121004333098598400e+25L,        /*  25! */
        4.032914611266056355840e+26L,        /*  26! */
        1.088886945041835216077e+28L,        /*  27! */
        3.048883446117138605015e+29L,        /*  28! */
        8.841761993739701954544e+30L,        /*  29! */
        2.652528598121910586363e+32L,        /*  30! */
        8.222838654177922817726e+33L,        /*  31! */
        2.631308369336935301672e+35L,        /*  32! */
        8.683317618811886495518e+36L,        /*  33! */
        2.952327990396041408476e+38L,        /*  34! */
        1.033314796638614492967e+40L,        /*  35! */
        3.719933267899012174680e+41L,        /*  36! */
        1.376375309122634504632e+43L,        /*  37! */
        5.230226174666011117600e+44L,        /*  38! */
        2.039788208119744335864e+46L,        /*  39! */
        8.159152832478977343456e+47L,        /*  40! */
        3.345252661316380710817e+49L,        /*  41! */
        1.405006117752879898543e+51L,        /*  42! */
        6.041526306337383563736e+52L,        /*  43! */
        2.658271574788448768044e+54L,        /*  44! */
        1.196222208654801945620e+56L,        /*  45! */
        5.502622159812088949850e+57L,        /*  46! */
        2.586232415111681806430e+59L,        /*  47! */
        1.241391559253607267086e+61L,        /*  48! */
        6.082818640342675608723e+62L,        /*  49! */
        3.041409320171337804361e+64L,        /*  50! */
        1.551118753287382280224e+66L,        /*  51! */
        8.065817517094387857166e+67L,        /*  52! */
        4.274883284060025564298e+69L,        /*  53! */
        2.308436973392413804721e+71L,        /*  54! */
        1.269640335365827592597e+73L,        /*  55! */
        7.109985878048634518540e+74L,        /*  56! */
        4.052691950487721675568e+76L,        /*  57! */
        2.350561331282878571829e+78L,        /*  58! */
        1.386831185456898357379e+80L,        /*  59! */
        8.320987112741390144276e+81L,        /*  60! */
        5.075802138772247988009e+83L,        /*  61! */
        3.146997326038793752565e+85L,        /*  62! */
        1.982608315404440064116e+87L,        /*  63! */
        1.268869321858841641034e+89L,        /*  64! */
        8.247650592082470666723e+90L,        /*  65! */
        5.443449390774430640037e+92L,        /*  66! */
        3.647111091818868528825e+94L,        /*  67! */
        2.480035542436830599601e+96L,        /*  68! */
        1.711224524281413113725e+98L,        /*  69! */
        1.197857166996989179607e+100L,       /*  70! */
        8.504785885678623175212e+101L,       /*  71! */
        6.123445837688608686152e+103L,       /*  72! */
        4.470115461512684340891e+105L,       /*  73! */
        3.307885441519386412260e+107L,       /*  74! */
        2.480914081139539809195e+109L,       /*  75! */
        1.885494701666050254988e+111L,       /*  76! */
        1.451830920282858696341e+113L,       /*  77! */
        1.132428117820629783146e+115L,       /*  78! */
        8.946182130782975286851e+116L,       /*  79! */
        7.156945704626380229481e+118L,       /*  80! */
        5.797126020747367985880e+120L,       /*  81! */
        4.753643337012841748421e+122L,       /*  82! */
        3.945523969720658651190e+124L,       /*  83! */
        3.314240134565353266999e+126L,       /*  84! */
        2.817104114380550276949e+128L,       /*  85! */
        2.422709538367273238177e+130L,       /*  86! */
        2.107757298379527717214e+132L,       /*  87! */
        1.854826422573984391148e+134L,       /*  88! */
        1.650795516090846108122e+136L,       /*  89! */
        1.485715964481761497310e+138L,       /*  90! */
        1.352001527678402962552e+140L,       /*  91! */
        1.243841405464130725548e+142L,       /*  92! */
        1.156772507081641574759e+144L,       /*  93! */
        1.087366156656743080274e+146L,       /*  94! */
        1.032997848823905926260e+148L,       /*  95! */
        9.916779348709496892096e+149L,       /*  96! */
        9.619275968248211985333e+151L,       /*  97! */
        9.426890448883247745626e+153L,       /*  98! */
        9.332621544394415268170e+155L,       /*  99! */
        9.332621544394415268170e+157L,       /* 100! */
        9.425947759838359420852e+159L,       /* 101! */
        9.614466715035126609269e+161L,       /* 102! */
        9.902900716486180407547e+163L,       /* 103! */
        1.029901674514562762385e+166L,       /* 104! */
        1.081396758240290900504e+168L,       /* 105! */
        1.146280563734708354534e+170L,       /* 106! */
        1.226520203196137939352e+172L,       /* 107! */
        1.324641819451828974500e+174L,       /* 108! */
        1.443859583202493582205e+176L,       /* 109! */
        1.588245541522742940425e+178L,       /* 110! */
        1.762952551090244663872e+180L,       /* 111! */
        1.974506857221074023537e+182L,       /* 112! */
        2.231192748659813646597e+184L,       /* 113! */
        2.543559733472187557120e+186L,       /* 114! */
        2.925093693493015690688e+188L,       /* 115! */
        3.393108684451898201198e+190L,       /* 116! */
        3.969937160808720895402e+192L,       /* 117! */
        4.684525849754290656574e+194L,       /* 118! */
        5.574585761207605881323e+196L,       /* 119! */
        6.689502913449127057588e+198L,       /* 120! */
        8.094298525273443739682e+200L,       /* 121! */
        9.875044200833601362412e+202L,       /* 122! */
        1.214630436702532967577e+205L,       /* 123! */
        1.506141741511140879795e+207L,       /* 124! */
        1.882677176888926099744e+209L,       /* 125! */
        2.372173242880046885677e+211L,       /* 126! */
        3.012660018457659544810e+213L,       /* 127! */
        3.856204823625804217357e+215L,       /* 128! */
        4.974504222477287440390e+217L,       /* 129! */
        6.466855489220473672507e+219L,       /* 130! */
        8.471580690878820510985e+221L,       /* 131! */
        1.118248651196004307450e+224L,       /* 132! */
        1.487270706090685728908e+226L,       /* 133! */
        1.992942746161518876737e+228L,       /* 134! */
        2.690472707318050483595e+230L,       /* 135! */
        3.659042881952548657690e+232L,       /* 136! */
        5.012888748274991661035e+234L,       /* 137! */
        6.917786472619488492228e+236L,       /* 138! */
        9.615723196941089004197e+238L,       /* 139! */
        1.346201247571752460588e+241L,       /* 140! */
        1.898143759076170969429e+243L,       /* 141! */
        2.695364137888162776589e+245L,       /* 142! */
        3.854370717180072770522e+247L,       /* 143! */
        5.550293832739304789551e+249L,       /* 144! */
        8.047926057471991944849e+251L,       /* 145! */
        1.174997204390910823948e+254L,       /* 146! */
        1.727245890454638911203e+256L,       /* 147! */
        2.556323917872865588581e+258L,       /* 148! */
        3.808922637630569726986e+260L,       /* 149! */
        5.713383956445854590479e+262L,       /* 150! */
        8.627209774233240431623e+264L,       /* 151! */
        1.311335885683452545607e+267L,       /* 152! */
        2.006343905095682394778e+269L,       /* 153! */
        3.089769613847350887959e+271L,       /* 154! */
        4.789142901463393876336e+273L,       /* 155! */
        7.471062926282894447084e+275L,       /* 156! */
        1.172956879426414428192e+278L,       /* 157! */
        1.853271869493734796544e+280L,       /* 158! */
        2.946702272495038326504e+282L,       /* 159! */
        4.714723635992061322407e+284L,       /* 160! */
        7.590705053947218729075e+286L,       /* 161! */
        1.229694218739449434110e+289L,       /* 162! */
        2.004401576545302577600e+291L,       /* 163! */
        3.287218585534296227263e+293L,       /* 164! */
        5.423910666131588774984e+295L,       /* 165! */
        9.003691705778437366474e+297L,       /* 166! */
        1.503616514864999040201e+300L,       /* 167! */
        2.526075744973198387538e+302L,       /* 168! */
        4.269068009004705274939e+304L,       /* 169! */
        7.257415615307998967397e+306L        /* 170! */
};

static const int factorials_size = sizeof(factorials) / sizeof(long double);

static long double const lnfactorials[] = {
        0.000000000000000000000e+0L,       /*   0! */
        0.000000000000000000000e+0L,       /*   1! */
        6.931471805599453094172e-1L,       /*   2! */
        1.791759469228055000812e+0L,       /*   3! */
        3.178053830347945619647e+0L,       /*   4! */
        4.787491742782045994248e+0L,       /*   5! */
        6.579251212010100995060e+0L,       /*   6! */
        8.525161361065414300166e+0L,       /*   7! */
        1.060460290274525022842e+1L,       /*   8! */
        1.280182748008146961121e+1L,       /*   9! */
        1.510441257307551529523e+1L,       /*  10! */
        1.750230784587388583929e+1L,       /*  11! */
        1.998721449566188614952e+1L,       /*  12! */
        2.255216385312342288557e+1L,       /*  13! */
        2.519122118273868150009e+1L,       /*  14! */
        2.789927138384089156609e+1L,       /*  15! */
        3.067186010608067280376e+1L,       /*  16! */
        3.350507345013688888401e+1L,       /*  17! */
        3.639544520803305357622e+1L,       /*  18! */
        3.933988418719949403622e+1L,       /*  19! */
        4.233561646075348502966e+1L,       /*  20! */
        4.538013889847690802616e+1L,       /*  21! */
        4.847118135183522387964e+1L,       /*  22! */
        5.160667556776437357045e+1L,       /*  23! */
        5.478472939811231919009e+1L,       /*  24! */
        5.800360522298051993929e+1L,       /*  25! */
        6.126170176100200198477e+1L,       /*  26! */
        6.455753862700633105895e+1L,       /*  27! */
        6.788974313718153498289e+1L,       /*  28! */
        7.125703896716800901007e+1L,       /*  29! */
        7.465823634883016438549e+1L,       /*  30! */
        7.809222355331531063142e+1L,       /*  31! */
        8.155795945611503717850e+1L,       /*  32! */
        8.505446701758151741396e+1L,       /*  33! */
        8.858082754219767880363e+1L,       /*  34! */
        9.213617560368709248333e+1L,       /*  35! */
        9.571969454214320248496e+1L,       /*  36! */
        9.933061245478742692933e+1L,       /*  37! */
        1.029681986145138126988e+2L,       /*  38! */
        1.066317602606434591262e+2L,       /*  39! */
        1.103206397147573954291e+2L,       /*  40! */
        1.140342117814617032329e+2L,       /*  41! */
        1.177718813997450715388e+2L,       /*  42! */
        1.215330815154386339623e+2L,       /*  43! */
        1.253172711493568951252e+2L,       /*  44! */
        1.291239336391272148826e+2L,       /*  45! */
        1.329525750356163098828e+2L,       /*  46! */
        1.368027226373263684696e+2L,       /*  47! */
        1.406739236482342593987e+2L,       /*  48! */
        1.445657439463448860089e+2L,       /*  49! */
        1.484777669517730320675e+2L,       /*  50! */
        1.524095925844973578392e+2L,       /*  51! */
        1.563608363030787851941e+2L,       /*  52! */
        1.603311282166309070282e+2L,       /*  53! */
        1.643201122631951814118e+2L,       /*  54! */
        1.683274454484276523305e+2L,       /*  55! */
        1.723527971391628015638e+2L,       /*  56! */
        1.763958484069973517152e+2L,       /*  57! */
        1.804562914175437710518e+2L,       /*  58! */
        1.845338288614494905025e+2L,       /*  59! */
        1.886281734236715911873e+2L,       /*  60! */
        1.927390472878449024360e+2L,       /*  61! */
        1.968661816728899939914e+2L,       /*  62! */
        2.010093163992815266793e+2L,       /*  63! */
        2.051681994826411985358e+2L,       /*  64! */
        2.093425867525368356464e+2L,       /*  65! */
        2.135322414945632611913e+2L,       /*  66! */
        2.177369341139542272510e+2L,       /*  67! */
        2.219564418191303339501e+2L,       /*  68! */
        2.261905483237275933323e+2L,       /*  69! */
        2.304390435657769523214e+2L,       /*  70! */
        2.347017234428182677427e+2L,       /*  71! */
        2.389783895618343230538e+2L,       /*  72! */
        2.432688490029827141829e+2L,       /*  73! */
        2.475729140961868839366e+2L,       /*  74! */
        2.518904022097231943772e+2L,       /*  75! */
        2.562211355500095254561e+2L,       /*  76! */
        2.605649409718632093053e+2L,       /*  77! */
        2.649216497985528010421e+2L,       /*  78! */
        2.692910976510198225363e+2L,       /*  79! */
        2.736731242856937041486e+2L,       /*  80! */
        2.780675734403661429141e+2L,       /*  81! */
        2.824742926876303960274e+2L,       /*  82! */
        2.868931332954269939509e+2L,       /*  83! */
        2.913239500942703075662e+2L,       /*  84! */
        2.957666013507606240211e+2L,       /*  85! */
        3.002209486470141317540e+2L,       /*  86! */
        3.046868567656687154726e+2L,       /*  87! */
        3.091641935801469219449e+2L,       /*  88! */
        3.136528299498790617832e+2L,       /*  89! */
        3.181526396202093268500e+2L,       /*  90! */
        3.226634991267261768912e+2L,       /*  91! */
        3.271852877037752172008e+2L,       /*  92! */
        3.317178871969284731381e+2L,       /*  93! */
        3.362611819791984770344e+2L,       /*  94! */
        3.408150588707990178690e+2L,       /*  95! */
        3.453794070622668541074e+2L,       /*  96! */
        3.499541180407702369296e+2L,       /*  97! */
        3.545390855194408088492e+2L,       /*  98! */
        3.591342053695753987760e+2L,       /*  99! */
        3.637393755555634901441e+2L,       /* 100! */
        3.683544960724047495950e+2L,       /* 101! */
        3.729794688856890206760e+2L,       /* 102! */
        3.776141978739186564468e+2L,       /* 103! */
        3.822585887730600291111e+2L,       /* 104! */
        3.869125491232175524822e+2L,       /* 105! */
        3.915759882173296196258e+2L,       /* 106! */
        3.962488170517915257991e+2L,       /* 107! */
        4.009309482789157454921e+2L,       /* 108! */
        4.056222961611448891925e+2L,       /* 109! */
        4.103227765269373054205e+2L,       /* 110! */
        4.150323067282496395563e+2L,       /* 111! */
        4.197508055995447340991e+2L,       /* 112! */
        4.244781934182570746677e+2L,       /* 113! */
        4.292143918666515701285e+2L,       /* 114! */
        4.339593239950148201939e+2L,       /* 115! */
        4.387129141861211848399e+2L,       /* 116! */
        4.434750881209189409588e+2L,       /* 117! */
        4.482457727453846057188e+2L,       /* 118! */
        4.530248962384961351041e+2L,       /* 119! */
        4.578123879812781810984e+2L,       /* 120! */
        4.626081785268749221865e+2L,       /* 121! */
        4.674121995716081787447e+2L,       /* 122! */
        4.722243839269805962399e+2L,       /* 123! */
        4.770446654925856331047e+2L,       /* 124! */
        4.818729792298879342285e+2L,       /* 125! */
        4.867092611368394122258e+2L,       /* 126! */
        4.915534482232980034989e+2L,       /* 127! */
        4.964054784872176206648e+2L,       /* 128! */
        5.012652908915792927797e+2L,       /* 129! */
        5.061328253420348751997e+2L,       /* 130! */
        5.110080226652360267439e+2L,       /* 131! */
        5.158908245878223975982e+2L,       /* 132! */
        5.207811737160441513633e+2L,       /* 133! */
        5.256790135159950627324e+2L,       /* 134! */
        5.305842882944334921812e+2L,       /* 135! */
        5.354969431801695441897e+2L,       /* 136! */
        5.404169241059976691050e+2L,       /* 137! */
        5.453441777911548737966e+2L,       /* 138! */
        5.502786517242855655538e+2L,       /* 139! */
        5.552202941468948698523e+2L,       /* 140! */
        5.601690540372730381305e+2L,       /* 141! */
        5.651248810948742988613e+2L,       /* 142! */
        5.700877257251342061414e+2L,       /* 143! */
        5.750575390247102067619e+2L,       /* 144! */
        5.800342727671307811636e+2L,       /* 145! */
        5.850178793888391176022e+2L,       /* 146! */
        5.900083119756178539038e+2L,       /* 147! */
        5.950055242493819689670e+2L,       /* 148! */
        6.000094705553274281080e+2L,       /* 149! */
        6.050201058494236838580e+2L,       /* 150! */
        6.100373856862386081868e+2L,       /* 151! */
        6.150612662070848845750e+2L,       /* 152! */
        6.200917041284773200381e+2L,       /* 153! */
        6.251286567308909491967e+2L,       /* 154! */
        6.301720818478101958172e+2L,       /* 155! */
        6.352219378550597328635e+2L,       /* 156! */
        6.402781836604080409209e+2L,       /* 157! */
        6.453407786934350077245e+2L,       /* 158! */
        6.504096828956552392500e+2L,       /* 159! */
        6.554848567108890661717e+2L,       /* 160! */
        6.605662610758735291676e+2L,       /* 161! */
        6.656538574111059132426e+2L,       /* 162! */
        6.707476076119126755767e+2L,       /* 163! */
        6.758474740397368739994e+2L,       /* 164! */
        6.809534195136374546094e+2L,       /* 165! */
        6.860654073019939978423e+2L,       /* 166! */
        6.911834011144107529496e+2L,       /* 167! */
        6.963073650938140118743e+2L,       /* 168! */
        7.014372638087370853465e+2L,       /* 169! */
        7.065730622457873471107e+2L,       /* 170! */
        7.117147258022900069535e+2L,       /* 171! */
};
static const int lnfactorials_size = sizeof(lnfactorials) / sizeof(long double);

static const long double log_sqrt_2pi = 9.18938533204672741780329736e-1L;

/* Bernoulli numbers B(2),B(4),B(6),...,B(20).  Only B(2),...,B(10) currently
   used. */

static const long double B[] = {
        1.0L / (long double)(6 * 2 * 1),
        -1.0L / (long double)(30 * 4 * 3),
        1.0L / (long double)(42 * 6 * 5),
        -1.0L / (long double)(30 * 8 * 7),
        5.0L / (long double)(66 * 10 * 9),
        -691.0L / (long double)(2730 * 12 * 11),
        7.0L / (long double)(6 * 14 * 13),
        -3617.0L / (long double)(510 * 16 * 15),
        43867.0L / (long double)(796 * 18 * 17),
        -174611.0L / (long double)(330 * 20 * 19)
};

static long double __cml_lnfactorial_asymptotic_expansion(int n);

/*
 * This function computes n! for 0 <= n <= Factorial_Max_Arg().  If
 * n > Factorial_Max_Arg(), then DBL_MAX is returned and if n < 0, then
 * 0 is returned.
 *
 */

double
cml_sf_fact(double n)
{
        /* For a large postive argument (n >= factorials_size) return DBL_MAX */

        if (n >= factorials_size)
        {
                return DBL_MAX;
        }

        /* Otherwise return n!. */

        if (cml_isinteger(n) && n >= 0.0)
        {
                return (double) factorials[(int) n];
        }

        return cml_sf_gamma(++n);
}


double
cml_sf_lnfact(double n)
{
        /* For a negative argument (n < 0) return LDBL_MAX */

        if (n < 0)
        {
                return -LDBL_MAX;
        }

        /* If n < N then return ln(n!). */

        if (!cml_isinteger(n))
        {
                return cml_sf_lngamma(++n);
        }
        else if (n < lnfactorials_size)
        {
                return (double) lnfactorials[(int) n];
        }

        /* Otherwise return asymptotic expansion of ln(n!). */

        return (double) __cml_lnfactorial_asymptotic_expansion((int) n);
}


static long double
__cml_lnfactorial_asymptotic_expansion(int n)
{
        const int m = 6;
        long double term[6];
        long double sum;
        long double xx = (long double) ((n + 1) * (n + 1));
        long double xj = (long double) (n + 1);
        long double lnfactorial = log_sqrt_2pi - xj + (xj - 0.5L) * (long double) cml_log((double) xj);
        int i;

        for (i = 0; i < m; i++) {
                term[i] = B[i] / xj;
                xj *= xx;
        }

        sum = term[m-1];

        for (i = m - 2; i >= 0; i--)
        {
                if (!(cml_abs(sum) > cml_abs(term[i])))
                {
                        break;
                }

                sum = term[i];
        }

        for (; i >= 0; i--)
        {
                sum += term[i];
        }

        return lnfactorial + sum;
}
